-- Cyclone Formation Prediction Storage Schema
-- Add these tables to your existing Supabase database

-- Create the handle_updated_at function first (required for triggers)
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create cyclone formation predictions table
CREATE TABLE public.cyclone_formation_predictions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  prediction_id TEXT NOT NULL, -- The ID generated by the prediction system
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- Prediction details
  location_lat DECIMAL(10,8) NOT NULL,
  location_lng DECIMAL(11,8) NOT NULL,
  formation_probability DECIMAL(5,4) NOT NULL CHECK (formation_probability >= 0 AND formation_probability <= 1),
  time_to_formation DECIMAL(8,2) NOT NULL, -- hours
  expected_formation_date TIMESTAMP WITH TIME ZONE NOT NULL,
  expected_intensity TEXT CHECK (expected_intensity IN ('tropical-depression', 'tropical-storm', 'category-1', 'category-2+')) NOT NULL,
  confidence DECIMAL(5,4) NOT NULL CHECK (confidence >= 0 AND confidence <= 1),
  region TEXT NOT NULL,
  
  -- Environmental factors (boolean assessments)
  sea_temp_favorable BOOLEAN NOT NULL,
  low_wind_shear BOOLEAN NOT NULL,
  sufficient_moisture BOOLEAN NOT NULL,
  atmospheric_instability BOOLEAN NOT NULL,
  
  -- Prediction source
  prediction_method TEXT CHECK (prediction_method IN ('statistical', 'neural-network', 'hybrid')) DEFAULT 'statistical',
  model_version TEXT,
  
  -- Validation tracking
  is_verified BOOLEAN DEFAULT false,
  actual_formation_date TIMESTAMP WITH TIME ZONE,
  actual_intensity TEXT CHECK (actual_intensity IN ('no-formation', 'tropical-depression', 'tropical-storm', 'category-1', 'category-2+')) DEFAULT 'no-formation',
  accuracy_score DECIMAL(5,4), -- Calculated accuracy when verified
  
  -- Indexes for common queries
  UNIQUE(prediction_id)
);

-- Create cyclone formation prediction accuracy tracking
CREATE TABLE public.prediction_accuracy_metrics (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- Time period for metrics
  period_start TIMESTAMP WITH TIME ZONE NOT NULL,
  period_end TIMESTAMP WITH TIME ZONE NOT NULL,
  
  -- Accuracy statistics
  total_predictions INTEGER NOT NULL DEFAULT 0,
  verified_predictions INTEGER NOT NULL DEFAULT 0,
  correct_formations INTEGER NOT NULL DEFAULT 0,
  false_positives INTEGER NOT NULL DEFAULT 0,
  false_negatives INTEGER NOT NULL DEFAULT 0,
  
  -- Performance metrics
  accuracy_rate DECIMAL(5,4), -- Overall accuracy
  precision_rate DECIMAL(5,4), -- Precision (correct formations / total predicted formations)
  recall_rate DECIMAL(5,4), -- Recall (correct formations / total actual formations)
  f1_score DECIMAL(5,4), -- F1 score
  
  -- Intensity accuracy
  intensity_accuracy_rate DECIMAL(5,4),
  timing_accuracy_hours DECIMAL(8,2), -- Average hours off from actual formation
  
  -- Regional breakdown
  region TEXT NOT NULL,
  prediction_method TEXT CHECK (prediction_method IN ('statistical', 'neural-network', 'hybrid')) DEFAULT 'statistical',
  
  UNIQUE(period_start, period_end, region, prediction_method)
);

-- Create real-time prediction status table (for live monitoring)
CREATE TABLE public.cyclone_prediction_status (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- Status information
  last_prediction_run TIMESTAMP WITH TIME ZONE NOT NULL,
  active_predictions_count INTEGER NOT NULL DEFAULT 0,
  high_probability_count INTEGER NOT NULL DEFAULT 0, -- predictions > 70%
  regions_monitored TEXT[] NOT NULL DEFAULT '{}',
  
  -- System health
  prediction_system_status TEXT CHECK (prediction_system_status IN ('healthy', 'degraded', 'offline')) DEFAULT 'healthy',
  last_error_message TEXT,
  last_error_time TIMESTAMP WITH TIME ZONE,
  
  -- Performance metrics
  average_prediction_time_ms INTEGER,
  total_api_calls_today INTEGER DEFAULT 0,
  
  -- Should only have one active row
  is_current BOOLEAN DEFAULT true,
  
  UNIQUE(is_current) DEFERRABLE INITIALLY DEFERRED
);

-- Enable Row Level Security
ALTER TABLE public.cyclone_formation_predictions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.prediction_accuracy_metrics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.cyclone_prediction_status ENABLE ROW LEVEL SECURITY;

-- Create RLS Policies (Allow public read access for prediction data, admin only for writes)

-- Cyclone predictions: Public read, system write
CREATE POLICY "Anyone can view cyclone predictions" ON public.cyclone_formation_predictions
  FOR SELECT TO PUBLIC USING (true);

CREATE POLICY "System can insert cyclone predictions" ON public.cyclone_formation_predictions
  FOR INSERT TO PUBLIC WITH CHECK (true);

CREATE POLICY "System can update cyclone predictions" ON public.cyclone_formation_predictions
  FOR UPDATE TO PUBLIC USING (true);

-- Accuracy metrics: Public read, system write
CREATE POLICY "Anyone can view accuracy metrics" ON public.prediction_accuracy_metrics
  FOR SELECT TO PUBLIC USING (true);

CREATE POLICY "System can insert accuracy metrics" ON public.prediction_accuracy_metrics
  FOR INSERT TO PUBLIC WITH CHECK (true);

CREATE POLICY "System can update accuracy metrics" ON public.prediction_accuracy_metrics
  FOR UPDATE TO PUBLIC USING (true);

-- Prediction status: Public read, system write
CREATE POLICY "Anyone can view prediction status" ON public.cyclone_prediction_status
  FOR SELECT TO PUBLIC USING (true);

CREATE POLICY "System can insert prediction status" ON public.cyclone_prediction_status
  FOR INSERT TO PUBLIC WITH CHECK (true);

CREATE POLICY "System can update prediction status" ON public.cyclone_prediction_status
  FOR UPDATE TO PUBLIC USING (true);

-- Create functions for managing prediction accuracy

-- Function to calculate prediction accuracy when verified
CREATE OR REPLACE FUNCTION public.calculate_prediction_accuracy(
  predicted_formation TIMESTAMP WITH TIME ZONE,
  actual_formation TIMESTAMP WITH TIME ZONE,
  predicted_intensity TEXT,
  actual_intensity TEXT,
  prediction_probability DECIMAL
) RETURNS DECIMAL AS $$
DECLARE
  timing_score DECIMAL := 0;
  intensity_score DECIMAL := 0;
  probability_score DECIMAL := 0;
  final_score DECIMAL := 0;
BEGIN
  -- If no formation occurred
  IF actual_intensity = 'no-formation' THEN
    -- Score based on how low the prediction probability was
    RETURN 1.0 - prediction_probability;
  END IF;
  
  -- Timing accuracy (within 24 hours = 1.0, beyond 168 hours = 0)
  IF actual_formation IS NOT NULL AND predicted_formation IS NOT NULL THEN
    timing_score := GREATEST(0, 1.0 - (EXTRACT(EPOCH FROM ABS(actual_formation - predicted_formation)) / 3600.0) / 168.0);
  END IF;
  
  -- Intensity accuracy
  CASE 
    WHEN predicted_intensity = actual_intensity THEN intensity_score := 1.0;
    WHEN (predicted_intensity = 'tropical-storm' AND actual_intensity = 'tropical-depression') OR 
         (predicted_intensity = 'tropical-depression' AND actual_intensity = 'tropical-storm') THEN 
         intensity_score := 0.8;
    WHEN (predicted_intensity = 'category-1' AND actual_intensity IN ('tropical-storm', 'category-2+')) OR
         (predicted_intensity IN ('tropical-storm', 'category-2+') AND actual_intensity = 'category-1') THEN
         intensity_score := 0.6;
    ELSE intensity_score := 0.3;
  END CASE;
  
  -- Probability score (higher probability for correct predictions gets bonus)
  probability_score := prediction_probability;
  
  -- Weighted final score
  final_score := (timing_score * 0.4) + (intensity_score * 0.4) + (probability_score * 0.2);
  
  RETURN LEAST(1.0, GREATEST(0.0, final_score));
END;
$$ LANGUAGE plpgsql;

-- Function to update prediction status
CREATE OR REPLACE FUNCTION public.update_prediction_status(
  prediction_count INTEGER,
  high_prob_count INTEGER,
  regions TEXT[],
  system_status TEXT DEFAULT 'healthy',
  error_msg TEXT DEFAULT NULL
) RETURNS VOID AS $$
BEGIN
  -- Disable current status
  UPDATE public.cyclone_prediction_status SET is_current = false WHERE is_current = true;
  
  -- Insert new status
  INSERT INTO public.cyclone_prediction_status (
    last_prediction_run,
    active_predictions_count,
    high_probability_count,
    regions_monitored,
    prediction_system_status,
    last_error_message,
    last_error_time
  ) VALUES (
    NOW(),
    prediction_count,
    high_prob_count,
    regions,
    system_status,
    error_msg,
    CASE WHEN error_msg IS NOT NULL THEN NOW() ELSE NULL END
  );
END;
$$ LANGUAGE plpgsql;

-- Create indexes for performance
CREATE INDEX idx_cyclone_predictions_location ON public.cyclone_formation_predictions(location_lat, location_lng);
CREATE INDEX idx_cyclone_predictions_formation_date ON public.cyclone_formation_predictions(expected_formation_date);
CREATE INDEX idx_cyclone_predictions_created_at ON public.cyclone_formation_predictions(created_at DESC);
CREATE INDEX idx_cyclone_predictions_probability ON public.cyclone_formation_predictions(formation_probability DESC);
CREATE INDEX idx_cyclone_predictions_region ON public.cyclone_formation_predictions(region);
CREATE INDEX idx_cyclone_predictions_verified ON public.cyclone_formation_predictions(is_verified, actual_formation_date);

CREATE INDEX idx_accuracy_metrics_period ON public.prediction_accuracy_metrics(period_start, period_end);
CREATE INDEX idx_accuracy_metrics_region ON public.prediction_accuracy_metrics(region);

CREATE INDEX idx_prediction_status_current ON public.cyclone_prediction_status(is_current) WHERE is_current = true;
CREATE INDEX idx_prediction_status_updated ON public.cyclone_prediction_status(updated_at DESC);

-- Create trigger for updated_at timestamps
CREATE TRIGGER handle_updated_at_cyclone_predictions BEFORE UPDATE ON public.cyclone_formation_predictions
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER handle_updated_at_prediction_status BEFORE UPDATE ON public.cyclone_prediction_status
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();