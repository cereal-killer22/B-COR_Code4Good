<!DOCTYPE html>
<html>
<head>
    <title>ClimaGuard Model Status Checker</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f8ff; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 10px 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ€ ClimaGuard Model Status Dashboard</h1>
        
        <div id="modelStatus" class="status info">
            ğŸ“‹ Checking model status...
        </div>
        
        <div id="trainingStatus" class="status info">
            ğŸ“Š Checking training history...
        </div>
        
        <div id="storageInfo" class="status info">
            ğŸ’¾ Checking storage details...
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="btn-primary" onclick="checkStatus()">ğŸ”„ Refresh Status</button>
            <button class="btn-success" onclick="startTraining()">ğŸš€ Start Training</button>
            <button class="btn-warning" onclick="clearModel()">ğŸ—‘ï¸ Clear Stored Model</button>
        </div>
        
        <div id="detailedInfo">
            <h3>ğŸ“‹ Detailed Information</h3>
            <pre id="storageDetails">Loading...</pre>
        </div>
    </div>

    <script>
        async function checkStatus() {
            document.getElementById('modelStatus').innerHTML = 'ğŸ“‹ Checking model status...';
            document.getElementById('trainingStatus').innerHTML = 'ğŸ“Š Checking training history...';
            document.getElementById('storageInfo').innerHTML = 'ğŸ’¾ Checking storage details...';
            
            // Check if trained model exists in localStorage
            let modelExists = false;
            let modelInfo = '';
            
            try {
                // Check for TensorFlow.js model in localStorage
                const modelKeys = [];
                if (typeof localStorage !== 'undefined' && localStorage !== null) {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && typeof key === 'string' && key.includes('tensorflowjs_models') && key.includes('cyclone-lstm-model')) {
                            modelKeys.push(key);
                            modelExists = true;
                        }
                    }
                }
                
                if (modelExists) {
                    document.getElementById('modelStatus').className = 'status success';
                    document.getElementById('modelStatus').innerHTML = 'âœ… <strong>Trained Model Found!</strong><br>ğŸ“ Stored in browser localStorage<br>ğŸ”‘ Keys found: ' + modelKeys.length;
                } else {
                    document.getElementById('modelStatus').className = 'status warning';
                    document.getElementById('modelStatus').innerHTML = 'âš ï¸ <strong>No Trained Model Found</strong><br>ğŸ“‹ Model needs to be trained first<br>ğŸ”§ Use "Start Training" button to train with real data';
                }
                
            } catch (error) {
                document.getElementById('modelStatus').className = 'status error';
                document.getElementById('modelStatus').innerHTML = 'âŒ <strong>Error Checking Model:</strong><br>' + error.message;
            }
            
            // Check training status
            try {
                const trainingStatus = localStorage.getItem('climaguard_training_status');
                
                if (trainingStatus) {
                    const status = JSON.parse(trainingStatus);
                    const lastTrained = new Date(status.lastTrainingTime);
                    const isRecent = Date.now() - status.lastTrainingTime < 24 * 60 * 60 * 1000;
                    
                    document.getElementById('trainingStatus').className = isRecent ? 'status success' : 'status warning';
                    document.getElementById('trainingStatus').innerHTML = `
                        ğŸ“Š <strong>Training History Found</strong><br>
                        ğŸ“… Last Training: ${lastTrained.toLocaleString()}<br>
                        ğŸ“ˆ Data Size: ${status.trainingDataSize} cyclone tracks<br>
                        ğŸ¯ Accuracy: ${(status.accuracy * 100).toFixed(1)}%<br>
                        ğŸ”„ Status: ${status.needsTraining ? 'Needs Retraining' : 'Up to Date'}
                    `;
                } else {
                    document.getElementById('trainingStatus').className = 'status warning';
                    document.getElementById('trainingStatus').innerHTML = 'âš ï¸ <strong>No Training History</strong><br>ğŸ“‹ Model has never been trained<br>ğŸš€ Run initial training to begin';
                }
            } catch (error) {
                document.getElementById('trainingStatus').className = 'status error';
                document.getElementById('trainingStatus').innerHTML = 'âŒ <strong>Error Checking Training Status:</strong><br>' + error.message;
            }
            
            // Storage information
            try {
                if (typeof localStorage === 'undefined' || localStorage === null) {
                    document.getElementById('storageInfo').innerHTML = 'âš ï¸ <strong>localStorage not available</strong>';
                    return;
                }
                
                const totalKeys = localStorage.length;
                const modelKeys = [];
                let totalSize = 0;
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && typeof key === 'string') {
                        const value = localStorage.getItem(key);
                        if (value && typeof value === 'string') {
                            totalSize += key.length + value.length;
                            if (key.includes('tensorflow') || key.includes('climaguard') || key.includes('cyclone')) {
                                modelKeys.push({
                                    key: key,
                                    size: (key.length + value.length) / 1024
                                });
                            }
                        }
                    }
                }
                
                document.getElementById('storageInfo').className = 'status info';
                document.getElementById('storageInfo').innerHTML = `
                    ğŸ’¾ <strong>Storage Information</strong><br>
                    ğŸ“Š Total localStorage Keys: ${totalKeys}<br>
                    ğŸ”‘ ClimaGuard Model Keys: ${modelKeys.length}<br>
                    ğŸ“ Estimated Size: ${(totalSize / 1024).toFixed(2)} KB
                `;
                
                // Detailed storage info
                let details = 'localStorage Contents (Model-related):\n\n';
                modelKeys.forEach(item => {
                    details += `ğŸ”‘ ${item.key}\n   Size: ${item.size.toFixed(2)} KB\n\n`;
                });
                
                if (modelKeys.length === 0) {
                    details += 'No model-related data found in localStorage.\nRun training to generate model files.\n\n';
                }
                
                details += `\nModel Storage Locations:\n`;
                details += `1. ğŸŒ Browser localStorage: localstorage://cyclone-lstm-model\n`;
                details += `2. ğŸ“ File system (optional): public/models/cyclone-lstm/model.json\n`;
                details += `3. ğŸ“Š Training status: climaguard_training_status key\n\n`;
                
                details += `Storage Mechanism:\n`;
                details += `â€¢ TensorFlow.js automatically saves model weights, topology, and optimizer state\n`;
                details += `â€¢ Each training session updates the stored model\n`;
                details += `â€¢ Browser localStorage persists between sessions\n`;
                details += `â€¢ Server restart doesn't affect stored models (client-side storage)`;
                
                document.getElementById('storageDetails').textContent = details;
                
            } catch (error) {
                document.getElementById('storageInfo').className = 'status error';
                document.getElementById('storageInfo').innerHTML = 'âŒ <strong>Error Checking Storage:</strong><br>' + error.message;
            }
        }
        
        async function startTraining() {
            if (confirm('Start model training? This will fetch real cyclone data and train the LSTM model.')) {
                try {
                    const response = await fetch('/api/cyclone-training', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'start_training' })
                    });
                    
                    if (response.ok) {
                        alert('ğŸš€ Training started! Check the console for progress updates.');
                        setTimeout(() => checkStatus(), 2000);
                    } else {
                        alert('âŒ Error starting training. Make sure the server is running.');
                    }
                } catch (error) {
                    alert('âŒ Error: ' + error.message);
                }
            }
        }
        
        function clearModel() {
            if (confirm('Clear all stored model data? This will remove the trained model and you will need to retrain.')) {
                try {
                    if (typeof localStorage === 'undefined' || localStorage === null) {
                        alert('âŒ localStorage is not available');
                        return;
                    }
                    
                    // Remove all model-related localStorage items
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && typeof key === 'string' && (key.includes('tensorflow') || key.includes('climaguard') || key.includes('cyclone'))) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    keysToRemove.forEach(key => {
                        if (key && typeof key === 'string') {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    alert(`ğŸ—‘ï¸ Cleared ${keysToRemove.length} model-related storage items.`);
                    checkStatus();
                } catch (error) {
                    alert('âŒ Error clearing storage: ' + (error instanceof Error ? error.message : String(error)));
                }
            }
        }
        
        // Check status on page load
        window.addEventListener('load', checkStatus);
    </script>
</body>
</html>